"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SouthAfricaIncomeTaxServiceImpl = void 0;
class SouthAfricaIncomeTaxServiceImpl {
    constructor(income, age, rules, medicalAidMembers = 0) {
        this._medicalAidMembers = 0;
        this._income = income;
        this._age = age;
        this._rules = rules;
        this._medicalAidMembers = medicalAidMembers;
    }
    calculateNetIncome() {
        const grossIncome = this._income;
        const threshold = this.getTaxThreshold(this._age);
        if (this._income <= threshold) {
            return {
                grossIncome,
                incomeTax: 0,
                uif: 0,
                totalDeductions: 0,
                netIncome: grossIncome,
                effectiveTaxRate: 0,
                taxBracketBreakdown: [],
            };
        }
        const { grossTax, bracketBreakdown } = this.calculateBracketTaxWithBreakdown(this._income);
        const rebate = this.getRebate(this._age);
        const medicalAidCredit = this.calculateMedicalAidCredit(this._medicalAidMembers);
        const incomeTax = Math.max(0, grossTax - rebate - medicalAidCredit);
        const uif = this.calculateUif(this._income);
        const totalDeductions = incomeTax + uif;
        const netIncome = grossIncome - totalDeductions;
        const effectiveTaxRate = incomeTax / grossIncome;
        return {
            grossIncome,
            incomeTax: this.round(incomeTax),
            uif: this.round(uif),
            totalDeductions: this.round(totalDeductions),
            netIncome: this.round(netIncome),
            effectiveTaxRate: this.round(effectiveTaxRate, 4),
            taxBracketBreakdown: bracketBreakdown,
        };
    }
    calculateBracketTaxWithBreakdown(income) {
        let tax = 0;
        const bracketBreakdown = [];
        for (let index = 0; index < this._rules.taxBrackets.length; index++) {
            const bracket = this._rules.taxBrackets[index];
            if (income <= bracket.from) {
                bracketBreakdown.push({
                    bracketIndex: index,
                    bracketName: `Bracket ${index + 1}`,
                    from: bracket.from,
                    to: bracket.to ?? null,
                    rate: bracket.rate,
                    amountInBracket: 0,
                    taxOnAmount: 0,
                });
                break;
            }
            const upper = bracket.to ?? income;
            const taxableAmount = Math.min(upper, income) - bracket.from;
            if (taxableAmount > 0) {
                const taxOnAmount = taxableAmount * bracket.rate;
                tax += taxOnAmount;
                bracketBreakdown.push({
                    bracketIndex: index,
                    bracketName: `Bracket ${index + 1}`,
                    from: bracket.from,
                    to: bracket.to ?? null,
                    rate: bracket.rate,
                    amountInBracket: taxableAmount,
                    taxOnAmount: taxOnAmount,
                });
            }
            else {
                bracketBreakdown.push({
                    bracketIndex: index,
                    bracketName: `Bracket ${index + 1}`,
                    from: bracket.from,
                    to: bracket.to ?? null,
                    rate: bracket.rate,
                    amountInBracket: 0,
                    taxOnAmount: 0,
                });
            }
        }
        return { grossTax: tax, bracketBreakdown };
    }
    calculateBracketTax(income) {
        let tax = 0;
        for (const bracket of this._rules.taxBrackets) {
            if (income <= bracket.from)
                break;
            const upper = bracket.to ?? income;
            const taxableAmount = Math.min(upper, income) - bracket.from;
            if (taxableAmount > 0) {
                tax += taxableAmount * bracket.rate;
            }
        }
        return tax;
    }
    getTaxThreshold(age) {
        const thresholds = this._rules.taxThresholds;
        if (age >= 75)
            return thresholds.age75Plus;
        if (age >= 65)
            return thresholds.age65To74;
        return thresholds.under65;
    }
    getRebate(age) {
        let rebate = this._rules.rebates.primary.amount;
        if (age >= this._rules.rebates.secondary.ageMin) {
            rebate += this._rules.rebates.secondary.amount;
        }
        if (age >= this._rules.rebates.tertiary.ageMin) {
            rebate += this._rules.rebates.tertiary.amount;
        }
        return rebate;
    }
    calculateUif(income) {
        const cappedIncome = Math.min(income, this._rules.uif.annualIncomeCap);
        return Math.min(cappedIncome * this._rules.uif.rate, this._rules.uif.maxAnnualContribution);
    }
    calculateMedicalAidCredit(members) {
        if (members <= 0)
            return 0;
        const monthly = this._rules.medicalAidTaxCredit.monthly;
        let monthlyCredit = monthly.taxpayer;
        if (members >= 2) {
            monthlyCredit += monthly.firstDependant;
        }
        if (members > 2) {
            monthlyCredit +=
                (members - 2) * monthly.additionalDependant;
        }
        return (monthlyCredit *
            this._rules.medicalAidTaxCredit.annualMultiplier);
    }
    round(value, decimals = 2) {
        return Number(value.toFixed(decimals));
    }
}
exports.SouthAfricaIncomeTaxServiceImpl = SouthAfricaIncomeTaxServiceImpl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU291dGhBZnJpY2FJbmNvbWVUYXhTZXJ2aWNlSW1wbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbmNvbWUtdGF4L3NvdXRoLWFmcmljYS9Tb3V0aEFmcmljYUluY29tZVRheFNlcnZpY2VJbXBsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUlBLE1BQWEsK0JBQStCO0lBTXhDLFlBQVksTUFBYyxFQUFFLEdBQVcsRUFBRSxLQUFxQixFQUFFLG9CQUE0QixDQUFDO1FBRnJGLHVCQUFrQixHQUFXLENBQUMsQ0FBQztRQUduQyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUNoQixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsaUJBQWlCLENBQUM7SUFDaEQsQ0FBQztJQUVELGtCQUFrQjtRQUNkLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFFakMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbEQsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQzVCLE9BQU87Z0JBQ0gsV0FBVztnQkFDWCxTQUFTLEVBQUUsQ0FBQztnQkFDWixHQUFHLEVBQUUsQ0FBQztnQkFDTixlQUFlLEVBQUUsQ0FBQztnQkFDbEIsU0FBUyxFQUFFLFdBQVc7Z0JBQ3RCLGdCQUFnQixFQUFFLENBQUM7Z0JBQ25CLG1CQUFtQixFQUFFLEVBQUU7YUFDMUIsQ0FBQztRQUNOLENBQUM7UUFFRCxNQUFNLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUzRixNQUFNLE1BQU0sR0FBRyxJQUFJLENB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QU0sQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7UUFFeEQsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztRQUVyQyxJQUFJLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNmLGFBQWEsSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDO1FBQzVDLENBQUM7UUFFRCxJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNkLGFBQWE7Z0JBQ1QsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDO1FBQ3BELENBQUM7UUFFRCxPQUFPLENBQ0gsYUFBYTtZQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQ25ELENBQUM7SUFDTixDQUFDO0lBRU8sS0FBSyxDQUFDLEtBQWEsRUFBRSxRQUFRLEdBQUcsQ0FBQztRQUNyQyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUNKO0FBdExELDBFQXNMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJyYWNrZXRBbGxvY2F0aW9uIH0gZnJvbSBcIi4uL2RvbWFpbi90eXBlc1wiO1xuaW1wb3J0IHsgQ29tcHV0ZWRJbmNvbWVUYXhWYWx1ZXMsIEluY29tZVRheFJ1bGVzIH0gZnJvbSBcIi4vZG9tYWluL3R5cGVzXCI7XG5pbXBvcnQgeyBTb3V0aEFmcmljYUluY29tZVRheFNlcnZpY2UgfSBmcm9tIFwiLi9Tb3V0aEFmcmljYUluY29tZVRheFNlcnZpY2VcIjtcblxuZXhwb3J0IGNsYXNzIFNvdXRoQWZyaWNhSW5jb21lVGF4U2VydmljZUltcGwgaW1wbGVtZW50cyBTb3V0aEFmcmljYUluY29tZVRheFNlcnZpY2Uge1xuICAgIHByaXZhdGUgX2luY29tZTogbnVtYmVyO1xuICAgIHByaXZhdGUgX2FnZTogbnVtYmVyO1xuICAgIHByaXZhdGUgX3J1bGVzOiBJbmNvbWVUYXhSdWxlcztcbiAgICBwcml2YXRlIF9tZWRpY2FsQWlkTWVtYmVyczogbnVtYmVyID0gMDtcblxuICAgIGNvbnN0cnVjdG9yKGluY29tZTogbnVtYmVyLCBhZ2U6IG51bWJlciwgcnVsZXM6IEluY29tZVRheFJ1bGVzLCBtZWRpY2FsQWlkTWVtYmVyczogbnVtYmVyID0gMCkge1xuICAgICAgICB0aGlzLl9pbmNvbWUgPSBpbmNvbWU7XG4gICAgICAgIHRoaXMuX2FnZSA9IGFnZTtcbiAgICAgICAgdGhpcy5fcnVsZXMgPSBydWxlcztcbiAgICAgICAgdGhpcy5fbWVkaWNhbEFpZE1lbWJlcnMgPSBtZWRpY2FsQWlkTWVtYmVycztcbiAgICB9XG5cbiAgICBjYWxjdWxhdGVOZXRJbmNvbWUoKTogQ29tcHV0ZWRJbmNvbWVUYXhWYWx1ZXMge1xuICAgICAgICBjb25zdCBncm9zc0luY29tZSA9IHRoaXMuX2luY29tZTtcblxuICAgICAgICBjb25zdCB0aHJlc2hvbGQgPSB0aGlzLmdldFRheFRocmVzaG9sZCh0aGlzLl9hZ2UpO1xuXG4gICAgICAgIGlmICh0aGlzLl9pbmNvbWUgPD0gdGhyZXNob2xkKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGdyb3NzSW5jb21lLFxuICAgICAgICAgICAgICAgIGluY29tZVRheDogMCxcbiAgICAgICAgICAgICAgICB1aWY6IDAsXG4gICAgICAgICAgICAgICAgdG90YWxEZWR1Y3Rpb25zOiAwLFxuICAgICAgICAgICAgICAgIG5ldEluY29tZTogZ3Jvc3NJbmNvbWUsXG4gICAgICAgICAgICAgICAgZWZmZWN0aXZlVGF4UmF0ZTogMCxcbiAgICAgICAgICAgICAgICB0YXhCcmFja2V0QnJlYWtkb3duOiBbXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IGdyb3NzVGF4LCBicmFja2V0QnJlYWtkb3duIH0gPSB0aGlzLmNhbGN1bGF0ZUJyYWNrZXRUYXhXaXRoQnJlYWtkb3duKHRoaXMuX2luY29tZSk7XG5cbiAgICAgICAgY29uc3QgcmViYXRlID0gdGhpcy5nZXRSZWJhdGUodGhpcy5fYWdlKTtcbiAgICAgICAgY29uc3QgbWVkaWNhbEFpZENyZWRpdCA9XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZU1lZGljYWxBaWRDcmVkaXQodGhpcy5fbWVkaWNhbEFpZE1lbWJlcnMpO1xuICAgICAgICBjb25zdCBpbmNvbWVUYXggPSBNYXRoLm1heCgwLCBncm9zc1RheCAtIHJlYmF0ZSAtIG1lZGljYWxBaWRDcmVkaXQpO1xuXG4gICAgICAgIGNvbnN0IHVpZiA9IHRoaXMuY2FsY3VsYXRlVWlmKHRoaXMuX2luY29tZSk7XG5cbiAgICAgICAgY29uc3QgdG90YWxEZWR1Y3Rpb25zID0gaW5jb21lVGF4ICsgdWlmO1xuICAgICAgICBjb25zdCBuZXRJbmNvbWUgPSBncm9zc0luY29tZSAtIHRvdGFsRGVkdWN0aW9ucztcbiAgICAgICAgY29uc3QgZWZmZWN0aXZlVGF4UmF0ZSA9IGluY29tZVRheCAvIGdyb3NzSW5jb21lO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBncm9zc0luY29tZSxcbiAgICAgICAgICAgIGluY29tZVRheDogdGhpcy5yb3VuZChpbmNvbWVUYXgpLFxuICAgICAgICAgICAgdWlmOiB0aGlzLnJvdW5kKHVpZiksXG4gICAgICAgICAgICB0b3RhbERlZHVjdGlvbnM6IHRoaXMucm91bmQodG90YWxEZWR1Y3Rpb25zKSxcbiAgICAgICAgICAgIG5ldEluY29tZTogdGhpcy5yb3VuZChuZXRJbmNvbWUpLFxuICAgICAgICAgICAgZWZmZWN0aXZlVGF4UmF0ZTogdGhpcy5yb3VuZChlZmZlY3RpdmVUYXhSYXRlLCA0KSxcbiAgICAgICAgICAgIHRheEJyYWNrZXRCcmVha2Rvd246IGJyYWNrZXRCcmVha2Rvd24sXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVCcmFja2V0VGF4V2l0aEJyZWFrZG93bihpbmNvbWU6IG51bWJlcik6IHsgZ3Jvc3NUYXg6IG51bWJlcjsgYnJhY2tldEJyZWFrZG93bjogQnJhY2tldEFsbG9jYXRpb25bXSB9IHtcbiAgICAgICAgbGV0IHRheCA9IDA7XG4gICAgICAgIGNvbnN0IGJyYWNrZXRCcmVha2Rvd246IEJyYWNrZXRBbGxvY2F0aW9uW10gPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5fcnVsZXMudGF4QnJhY2tldHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBicmFja2V0ID0gdGhpcy5fcnVsZXMudGF4QnJhY2tldHNbaW5kZXhdO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoaW5jb21lIDw9IGJyYWNrZXQuZnJvbSkge1xuICAgICAgICAgICAgICAgIGJyYWNrZXRCcmVha2Rvd24ucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGJyYWNrZXRJbmRleDogaW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIGJyYWNrZXROYW1lOiBgQnJhY2tldCAke2luZGV4ICsgMX1gLFxuICAgICAgICAgICAgICAgICAgICBmcm9tOiBicmFja2V0LmZyb20sXG4gICAgICAgICAgICAgICAgICAgIHRvOiBicmFja2V0LnRvID8/IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHJhdGU6IGJyYWNrZXQucmF0ZSxcbiAgICAgICAgICAgICAgICAgICAgYW1vdW50SW5CcmFja2V0OiAwLFxuICAgICAgICAgICAgICAgICAgICB0YXhPbkFtb3VudDogMCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdXBwZXIgPSBicmFja2V0LnRvID8/IGluY29tZTtcbiAgICAgICAgICAgIGNvbnN0IHRheGFibGVBbW91bnQgPSBNYXRoLm1pbih1cHBlciwgaW5jb21lKSAtIGJyYWNrZXQuZnJvbTtcblxuICAgICAgICAgICAgaWYgKHRheGFibGVBbW91bnQgPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGF4T25BbW91bnQgPSB0YXhhYmxlQW1vdW50ICogYnJhY2tldC5yYXRlO1xuICAgICAgICAgICAgICAgIHRheCArPSB0YXhPbkFtb3VudDtcbiAgICAgICAgICAgICAgICBicmFja2V0QnJlYWtkb3duLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBicmFja2V0SW5kZXg6IGluZGV4LFxuICAgICAgICAgICAgICAgICAgICBicmFja2V0TmFtZTogYEJyYWNrZXQgJHtpbmRleCArIDF9YCxcbiAgICAgICAgICAgICAgICAgICAgZnJvbTogYnJhY2tldC5mcm9tLFxuICAgICAgICAgICAgICAgICAgICB0bzogYnJhY2tldC50byA/PyBudWxsLFxuICAgICAgICAgICAgICAgICAgICByYXRlOiBicmFja2V0LnJhdGUsXG4gICAgICAgICAgICAgICAgICAgIGFtb3VudEluQnJhY2tldDogdGF4YWJsZUFtb3VudCxcbiAgICAgICAgICAgICAgICAgICAgdGF4T25BbW91bnQ6IHRheE9uQW1vdW50LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmFja2V0QnJlYWtkb3duLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBicmFja2V0SW5kZXg6IGluZGV4LFxuICAgICAgICAgICAgICAgICAgICBicmFja2V0TmFtZTogYEJyYWNrZXQgJHtpbmRleCArIDF9YCxcbiAgICAgICAgICAgICAgICAgICAgZnJvbTogYnJhY2tldC5mcm9tLFxuICAgICAgICAgICAgICAgICAgICB0bzogYnJhY2tldC50byA/PyBudWxsLFxuICAgICAgICAgICAgICAgICAgICByYXRlOiBicmFja2V0LnJhdGUsXG4gICAgICAgICAgICAgICAgICAgIGFtb3VudEluQnJhY2tldDogMCxcbiAgICAgICAgICAgICAgICAgICAgdGF4T25BbW91bnQ6IDAsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBncm9zc1RheDogdGF4LCBicmFja2V0QnJlYWtkb3duIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVCcmFja2V0VGF4KGluY29tZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHRheCA9IDA7XG5cbiAgICAgICAgZm9yIChjb25zdCBicmFja2V0IG9mIHRoaXMuX3J1bGVzLnRheEJyYWNrZXRzKSB7XG4gICAgICAgICAgICBpZiAoaW5jb21lIDw9IGJyYWNrZXQuZnJvbSkgYnJlYWs7XG5cbiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gYnJhY2tldC50byA/PyBpbmNvbWU7XG4gICAgICAgICAgICBjb25zdCB0YXhhYmxlQW1vdW50ID0gTWF0aC5taW4odXBwZXIsIGluY29tZSkgLSBicmFja2V0LmZyb207XG5cbiAgICAgICAgICAgIGlmICh0YXhhYmxlQW1vdW50ID4gMCkge1xuICAgICAgICAgICAgICAgIHRheCArPSB0YXhhYmxlQW1vdW50ICogYnJhY2tldC5yYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRheDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFRheFRocmVzaG9sZChhZ2U6IG51bWJlcik6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IHRocmVzaG9sZHMgPSB0aGlzLl9ydWxlcy50YXhUaHJlc2hvbGRzO1xuXG4gICAgICAgIGlmIChhZ2UgPj0gNzUpIHJldHVybiB0aHJlc2hvbGRzLmFnZTc1UGx1cztcbiAgICAgICAgaWYgKGFnZSA+PSA2NSkgcmV0dXJuIHRocmVzaG9sZHMuYWdlNjVUbzc0O1xuXG4gICAgICAgIHJldHVybiB0aHJlc2hvbGRzLnVuZGVyNjU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZWJhdGUoYWdlOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBsZXQgcmViYXRlID0gdGhpcy5fcnVsZXMucmViYXRlcy5wcmltYXJ5LmFtb3VudDtcblxuICAgICAgICBpZiAoYWdlID49IHRoaXMuX3J1bGVzLnJlYmF0ZXMuc2Vjb25kYXJ5LmFnZU1pbikge1xuICAgICAgICAgICAgcmViYXRlICs9IHRoaXMuX3J1bGVzLnJlYmF0ZXMuc2Vjb25kYXJ5LmFtb3VudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhZ2UgPj0gdGhpcy5fcnVsZXMucmViYXRlcy50ZXJ0aWFyeS5hZ2VNaW4pIHtcbiAgICAgICAgICAgIHJlYmF0ZSArPSB0aGlzLl9ydWxlcy5yZWJhdGVzLnRlcnRpYXJ5LmFtb3VudDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZWJhdGU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVVaWYoaW5jb21lOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBjYXBwZWRJbmNvbWUgPSBNYXRoLm1pbihcbiAgICAgICAgICAgIGluY29tZSxcbiAgICAgICAgICAgIHRoaXMuX3J1bGVzLnVpZi5hbm51YWxJbmNvbWVDYXAsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIE1hdGgubWluKFxuICAgICAgICAgICAgY2FwcGVkSW5jb21lICogdGhpcy5fcnVsZXMudWlmLnJhdGUsXG4gICAgICAgICAgICB0aGlzLl9ydWxlcy51aWYubWF4QW5udWFsQ29udHJpYnV0aW9uLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsY3VsYXRlTWVkaWNhbEFpZENyZWRpdChtZW1iZXJzOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBpZiAobWVtYmVycyA8PSAwKSByZXR1cm4gMDtcblxuICAgICAgICBjb25zdCBtb250aGx5ID0gdGhpcy5fcnVsZXMubWVkaWNhbEFpZFRheENyZWRpdC5tb250aGx5O1xuXG4gICAgICAgIGxldCBtb250aGx5Q3JlZGl0ID0gbW9udGhseS50YXhwYXllcjtcblxuICAgICAgICBpZiAobWVtYmVycyA+PSAyKSB7XG4gICAgICAgICAgICBtb250aGx5Q3JlZGl0ICs9IG1vbnRobHkuZmlyc3REZXBlbmRhbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWVtYmVycyA+IDIpIHtcbiAgICAgICAgICAgIG1vbnRobHlDcmVkaXQgKz1cbiAgICAgICAgICAgICAgICAobWVtYmVycyAtIDIpICogbW9udGhseS5hZGRpdGlvbmFsRGVwZW5kYW50O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIG1vbnRobHlDcmVkaXQgKlxuICAgICAgICAgICAgdGhpcy5fcnVsZXMubWVkaWNhbEFpZFRheENyZWRpdC5hbm51YWxNdWx0aXBsaWVyXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByb3VuZCh2YWx1ZTogbnVtYmVyLCBkZWNpbWFscyA9IDIpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gTnVtYmVyKHZhbHVlLnRvRml4ZWQoZGVjaW1hbHMpKTtcbiAgICB9XG59Il19